const mongoose = require('mongoose');
const Favorite = require('../model/model_favorite');
// Lấy toàn bộ danh sách sản phẩm yêu thích
exports.getAllFavorites = async (req, res) => {
    try {
        console.log('Getting all favorites...');

        //Lấy toàn bộ dữ liệu favorite trong DB
        const favorites = await Favorite.find().sort({ createdAt: -1 });

        console.log('Found favorites:', favorites.length);

        //Trả về JSON cho client
        res.json(favorites);
    } catch (error) {
        console.error('Get all favorites error:', error);
        res.status(500).json({ message: 'Lỗi khi lấy danh sách yêu thích', error: error.message });
    }
};
// Lấy danh sách sản phẩm yêu thích của user
exports.getUserFavorites = async (req, res) => {
    try {
        //userId lấy từ URL params
        const { userId } = req.params;
        console.log('Kiểm tra danh sách yêu thích của user:', userId); 

        //Kiểm tra xem userId có phải ObjectId hợp lệ không
        if (!mongoose.Types.ObjectId.isValid(userId)) {
            return res.status(400).json({ message: 'ID người dùng không hợp lệ' });
        }

        //Lấy tất cả favorite của user sắp xếp theo mới nhất
        const favorites = await Favorite.find({ userId }).sort({ createdAt: -1 });
        console.log(`Tổng số bản ghi favorite tìm được: ${favorites.length}`);

        const validFavorites = await Promise.all(
            favorites.map(async (fav) => {
                //Lấy type để xác định sản phẩm là sale hay normal
                const type = fav.type || 'normal';

                //Lấy sản phẩm tương ứng từ DB
                let product = (type = 'sale')
                    ? await SaleProduct.findById(fav.productId)
                    : await Product.findById(fav.productId);

                     //Nếu sản phẩm đã bị xoá - xoá luôn favorite
                if (!product) {
                    console.warn(`Sản phẩm đã bị xoá (productId: ${fav.productId}) => Xoá luôn favorite`);
                    await Favorite.findByIdAndDelete(fav._id);
                    return null;
                }

                //Nếu sản phẩm tồn tại - trả về object favorite kèm thông tin cơ bản của product
                return {
                    _id: fav._id,
                    userId: fav.userId,
                    productId: fav.productId,
                    type,
                    product: {
                        _id: product._id,
                        name: product.name,
                        price: type === 'sale' ? product.discount_price : product.price,
                        image: product.images?.[0] || '',
                    },
                };
            })
        );

         //Loại bỏ những favorite null (sản phẩm bị xoá) - 
        const filtered = validFavorites.filter(f => f !== null);
        res.json(filtered);
    } catch (error) {
        console.error('Lỗi khi lấy danh sách yêu thích:', error);
        res.status(500).json({ message: 'Lỗi khi lấy danh sách yêu thích', error: error.message });
    }
};
// Thêm sản phẩm vào danh sách yêu thích
exports.addToFavorites = async (req, res) => {
    try {
        //Lấy userId, productId, type từ request body - type mặc định là 'normal'
        const { userId, productId, type = 'normal' } = req.body;

        console.log('== ADD TO FAVORITES ==');
        console.log('userId:', userId, '| valid?', mongoose.Types.ObjectId.isValid(userId));
        console.log('productId:', productId, '| valid?', mongoose.Types.ObjectId.isValid(productId));
        console.log('type:', type);

        //Kiểm tra ObjectId hợp lệ
        if (!mongoose.Types.ObjectId.isValid(userId) || !mongoose.Types.ObjectId.isValid(productId)) {
            return res.status(400).json({ message: 'ID không hợp lệ' });
        }

        //Lấy sản phẩm tương ứng theo type
        let product;
        if (type === 'sale') {
            product = await SaleProduct.findById(productId);
        } else {
            product = await Product.findById(productId);
        }

        console.log('Found product:', !!product);

        //Nếu không tìm thấy - trả 404
        if (!product) {
            return res.status(404).json({ message: 'Không tìm thấy sản phẩm' });
        }

        //Kiểm tra sản phẩm đã có trong danh sách yêu thích chưa
        const existingFavorite = await Favorite.findOne({ userId, productId });
        if (existingFavorite) {
            return res.status(400).json({ message: 'Sản phẩm đã có trong danh sách yêu thích' });
        }

        //Tạo document mới trong collection Favorite và lưu vào DB
        const newFavorite = new Favorite({
            userId,
            productId,
            type,
            product: {
                name: product.name,
                price: product.price,
                image: product.images && product.images.length > 0 ? product.images[0] : '',
            }
        });

        await newFavorite.save();
        console.log('✅ New favorite saved:', newFavorite._id);
        res.status(201).json(newFavorite);
    } catch (error) {
        console.error('Add to favorites error:', error);
        res.status(500).json({ message: 'Lỗi khi thêm vào yêu thích', error: error.message });
    }
};

